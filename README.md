# JDKDD repository

![]()

TensorFlow implementation of JDKDD for CVPR'2020 paper [](), by Xuyang Bai, Zixin Luo, Lei Zhou, Long Quan, Hongbo Fu and Chiew-Lan Tai.

This paper focus on learning keypoint detector and feature descriptor for 3D point cloud in a joint manner. If you find this project useful, please cite:

```bash

```

## Installation

* Create the environment and install the required libaries:

           conda env create -f environment.yml

* Compile the customized Tensorflow operators located in `tf_custom_ops`. Open a terminal in this folder, and run:

          sh compile_op.sh

* Compile the C++ extension module for python located in `cpp_wrappers`. Open a terminal in this folder, and run:

          sh compile_wrappers.sh
          
The code is heavily borrowed from [KPConv](https://github.com/HuguesTHOMAS/KPConv/). You can find the guidance for compiling the tensorflow operators and C++ wrappers in [INSTALL.md](https://github.com/HuguesTHOMAS/KPConv/blob/master/INSTALL.md).

      
## Dataset Download

**3DMatch**

The training set can be downloaded from [here](https://drive.google.com/file/d/1Vo-D_NOs4HS9wwAE-55ggDpgaPfzdRRt/view?usp=sharing). It is generated by `cal_overlap.py` which select all the point cloud fragments pairs having more than 30% overlap.

The test set point clouds and the evaluation files(for registration recall) can be downloaded from [3DMatch Geometric Registration website.](http://3dmatch.cs.princeton.edu/#geometric-registration-benchmark)

**KITTI**

The training and test set can be download from [KITTI Odometry website.](http://www.cvlibs.net/datasets/kitti/eval_odometry.php)

**ETH**

The test set (we only use ETH dataset to evaluate the generalization ability of our method) can be downloaded from [here](https://share.phys.ethz.ch/~gsg/3DSmoothNet/data/ETH.rar).

## Instructions to training and testing

### 3DMatch

The training of 3DMatch can be done by running
```bash
python training_3dmatch.py
```
This file contains a configuration subclass `ThreeDMatchConfig`, inherited from the general configuration class Config defined in `utils/config.py`. The value of every parameter can be modified in the subclass. The default path to 3DMatch training set is `data/3DMatch`, which can be changed in `dataset/ThreeDMatch.py`. 

The testing with the pretrained models on 3DMatch can by easily done by changing the path of log in `test_3dmatch.py` file

```python
chosen_log = 'path_to_pretrained_log'
```

and runing

```bash
python test_3dmatch.py
```

The descriptors and detection scores for each point will be generated and saved in `geometric_registration` folder. Then the `feature matching recall` and `inlier ratio` can be caluclated by running
```bash
cd geometric_registration/
python evaluate.py JDKDD [timestr of the model]
```
The `registration recall` can be calculated by running the `evaluate.m` in `geometric_registration/3dmatch` which are provided by [3DMatch.](https://github.com/andyzeng/3dmatch-toolbox/tree/master/evaluation/geometric-registration)


### KITTI
Similarly, the training and testing of KITTI data set can be done by running
```bash
python training_KITTI.py
```
And 
```bash
python test_KITTI.py
```

### Keypoint Repeatability

For keypoint repeatability, after generating the descriptors and detection scores, then run

```bash
python evaluate_3dmatch_our.py JDKDD [timestr of the model]
```

or

```bash
python evaluate_kitti_our.py JDKDD [timestr of the model]
```



## Pretrained Model

The pretrained model of 3DMatch are in `results/` while the pretrained model of KITTI are in `results_kitti/`

## TODO
- create a requirement.txt
- Change the detector name from JDKDD to our.
